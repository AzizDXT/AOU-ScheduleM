<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Schedule Meeting</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <style>
        .container {
            margin-top: 30px;
        }
        .tutor-card {
            display: none; /* Hide initially */
        }
        .logo {
            max-width: 150px; /* Adjust the size of the logo as needed */
            margin-bottom: 20px; /* Space below the logo */
        }
    </style>
</head>
<body>
    <div class="container text-center">
        <!-- Logo -->
        <img src="AOU.png" alt="AOU Logo" class="logo"> <!-- تأكد من صحة المسار واسم الملف -->

        <h1 class="mt-4">Schedule a Meeting</h1>

        <!-- Search Input -->
        <input type="text" id="search" class="form-control mb-3" placeholder="Search by name or email">

        <!-- List of Tutors -->
        <div id="tutorsList">
            {% for tutor in tutors %}
            <div class="card mb-3 tutor-card">
                <div class="card-header">
                    <input type="checkbox" class="tutor-checkbox" data-name="{{ tutor['TUTOR'] }}" data-email="{{ tutor['AOU_EMAIL'] }}" data-schedule="{{ tutor['FullSchedule'] }}">
                    {{ tutor['TUTOR'] }} - {{ tutor['AOU_EMAIL'] }}
                </div>
                <div class="card-body">
                    <p>{{ tutor['FullSchedule'] }}</p>
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- Meeting Duration Input -->
        <label for="meetingDuration">Meeting Duration (hours):</label>
        <input type="number" id="meetingDuration" class="form-control mb-3" value="1" min="0.5" step="0.5">
        
        <!-- Button to Find Available Slots -->
        <button onclick="sendData()" class="btn btn-primary">Find Available Slots</button>
    </div>

    <script>
        // Filter function for searching tutors
        document.getElementById('search').addEventListener('input', function() {
            const query = this.value.toLowerCase(); // Get search query and convert to lowercase
            const tutorCards = document.querySelectorAll('.tutor-card'); // Get all tutor cards
            
            tutorCards.forEach(card => {
                const tutorName = card.querySelector('.tutor-checkbox').dataset.name.toLowerCase(); // Get tutor name
                const tutorEmail = card.querySelector('.tutor-checkbox').dataset.email.toLowerCase(); // Get tutor email
                
                if (tutorName.includes(query) || tutorEmail.includes(query)) {
                    card.style.display = 'block'; // Show card if it matches search query
                } else {
                    card.style.display = 'none'; // Hide card if it doesn't match search query
                }
            });
        });

        async function sendData() {
            const selectedTutors = [];
            const tutorCheckboxes = document.querySelectorAll('.tutor-checkbox:checked');

            tutorCheckboxes.forEach(checkbox => {
                selectedTutors.push({
                    name: checkbox.dataset.name,
                    email: checkbox.dataset.email,
                    schedule: checkbox.dataset.schedule
                });
            });

            if (selectedTutors.length === 0) {
                alert("Please select at least one tutor.");
                return;
            }

            const workingHours = "Sunday to Thursday, 8 AM to 10 PM";
            const schedules = selectedTutors.map(tutor => `${tutor.name}: ${tutor.schedule}`).join(', ');

            // Get the current date and time in Muscat timezone
            const now = new Date();
            const muscatTime = now.toLocaleString("en-US", { timeZone: "Asia/Muscat" });
            const currentDate = new Date(muscatTime).toISOString();  // ISO format for date and time

            const meetingDuration = document.getElementById('meetingDuration').value;

            const response = await fetch('https://api.openai.com/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer YOUR_API_KEY' // Replace with your actual API key
                },
                body: JSON.stringify({
                    model: "gpt-4o",
                    messages: [{
                        role: "user",
                        content: `I need to schedule a meeting with the following tutors during the working hours from ${workingHours}. Their schedules are as follows: ${schedules}. The current date and time is ${currentDate}. The meeting duration is ${meetingDuration} hours. Please find the 5 closest available meeting times starting from now where all selected tutors are free.`
                    }]
                })
            });

            const result = await response.json();
            const responseText = result.choices[0].message.content;

            // Redirect to the results page with the response
            window.location.href = `/response?response=${encodeURIComponent(responseText)}`;
        }
    </script>
</body>
</html>
